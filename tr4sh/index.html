<!doctype html>
<html>
<head>
	<link rel="icon" type="image/x-icon" href= "../icon.png"/>
	<title>Tier List Maker - Smash Apps</title>
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,100italic" rel="stylesheet" type="text/css">
	<link href="newstyle.css" rel="stylesheet">
	<link href="dragula.min.css" rel="stylesheet">
</head>
<body>
	<div id="controls">
		<h1>teir liss - <span>open dah lok at dah gaem nam butn 3 strt</span></h1>
		<div id="buttons">		 
			<button id="Bleg">random!!1!!1</button>
			<button id="screenshot">shar</button>
			<button id="hidebuttons">hid a da contrl</button>
			<button id="game">lok at gaem naem</button>
			<button id="help">croodits</button>
			<button id="reset">reses</button>
		</div>
	</div>
	
	<div id="tablewrap"><table><tbody>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">S</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">A</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">B</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">C</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">D</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">E</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
		<tr>
			<td class="labelHolder" contenteditable="true"><span class="label">F</span></td>
			<td><div class="tier sort" id="rows"></div></td>
			<td><div id="settings"></div><div id="moveButtons"><div id="moveUp"></div><div id="moveDown"></div></div></td>
		</tr>
	</tbody></table>
	</div>
	
	<div id="char" class="sort">
		<div>ief n0o caratrs er lodd hear, chos a gaem by SMASHING the "lok at gaem naem" butn upwad.</div>
	</div>
	
	<div id="overlay">
		<div id="modalWrapper">
			<div id="modal">
				<h1>setins</h1>
				<span id="close"></span>
				<p>colr ur kidd:</p>
				<div id="colorselect"><span style="background:#FF7F7F"></span><span style="background:#FFBF7F"></span><span style="background:#FFDF7F"></span><span style="background:#FFFF7F"></span><span style="background:#BFFF7F"></span><span style="background:#7FFF7F"></span><span style="background:#7FFFFF"></span><span style="background:#7FBFFF"></span><span style="background:#7F7FFF"></span><span style="background:#FF7FFF"></span><span style="background:#BF7FBF"></span><span style="background:#3B3B3B"></span><span style="background:#858585"></span><span style="background:#CFCFCF"></span><span style="background:#F7F7F7"></span></div>
				<p>naem ru kido:</p><textarea id="labelName"></textarea>
				<p>teh roo stf:</p>
				<p><button id="deleteRow">delet this</button> <button id="clearRow">clrr roew</button></p>
				<p><button id="addRowUp">ad roe up</button> <button id="addRowBelow">ad roe doen</button></p>
			</div>
			<div id="gameChange">
				<h1>ries and shine gameers</h1>
				<span id="close"></span>
				<div id="switchButtons">
					<button id="switchSmash4">trash</button>
					<button id="switchhelp">helpy bois</button>
					<button id="switchUltimate">the good one</button>

</div>
				<p><strong>choonging 4our gaem wil emptea 4our teirrliss!</strong> thats a big oof. </p>
				<p></p>
			</div>
			<div id="helpMenu">
				<h1>croodits</h1>
				<span id="close"></span>
				<p>spekial thnks 2wo :bleg: 4or ta radnom butt on xdd</p>
			</div>
		</div>
			<div id="screenshotShow">
				<span id="close"></span>
				<p>no 1 caers abut ur clod machupp chert, but hers teh img</p>
			<textarea id="exportcode" cols="30" rows="8"></textarea><div><button id="runCode">Run code</button></div>
			</div>
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="dragula.min.js"></script>
	<script src="html2canvas.js"></script>
	<script>
		dragula({
			isContainer: function (el) {
				return el.classList.contains('sort');
			}
		}).on("drop", function() {
			localStorage.setItem("TierListMakerCode",toCode());
		});
		
		// character images
		var singleChar = "<div class='character'></div>";
		var gamehelp = ["help","bleg","breck","broster","jab","jim","keko","latios","mvw","sfr"];
		var gameUltimate = ["ultimate","mario", "dk", "link", "samus", "darksamus","yoshi", "kirby", "fox", "pikachu", "luigi", "ness", "captainfalcon", "jigglypuff", "peach", "daisy", "bowser", "iceclimbers", "sheik", "zelda", "drmario", "pichu", "falco", "marth", "lucina", "ylink", "ganondorf", "mewtwo", "roy", "chrom","gameandwatch", "metaknight", "pit", "darkpit", "zss", "wario", "snake", "ike", "squirtle", "ivysaur", "charizard", "diddykong", "lucas", "sonic", "kingdedede", "olimar", "lucario", "rob", "toonlink", "wolf", "villager", "megaman", "wiifittrainer", "rosalina", "littlemac", "greninja", "miibrawler", "miigunner", "miiswordfighter", "palutena", "pacman", "robin", "shulk", "bowserjr", "duckhunt", "ryu", "ken", "cloud", "corrin", "bayonetta", "inkling", "ridley", "simon", "richter","kkrool","isabelle","incineroar"];
		var gameSmash4 = ["trash","mario","luigi","peach","bowser","yoshi","rosalinaluma","bowserjr","drmario","wario","donkeykong","diddykong","mrgamewatch","littlemac","link","zelda","sheik","ganondorf","toonlink","samus","zerosuitsamus","pit","palutena","darkpit","marth","marthcina","ike","robin","lucina","roy","corrin","duckhunt","kirby","kingdedede","metaknight","fox","falco","pikachu","charizard","lucario","jigglypuff","greninja","mewtwo","rob","ness","lucas","captainfalcon","villager","olimar","wiifittrainer","shulk","pacman","megaman","ryu","sonic","cloud","bayonetta","miibrawler1","miigunner1","miisword1","miibrawler","miigunner","miisword"];

		var gameSSB4Renders = ["ssb4r","mario","luigi","peach","bowser","yoshi","rosalinaluma","bowserjr","wario","donkeykong","diddykong","mrgamewatch","littlemac","link","zelda","sheik","ganondorf","toonlink","samus","zerosuitsamus","pit","palutena","marth","marthcina","ike","robin","duckhunt","kirby","kingdedede","metaknight","fox","falco","pikachu","charizard","lucario","jigglypuff","greninja","rob","ness","captainfalcon","villager","olimar","wiifittrainer","shulk","drmario","darkpit","lucina","pacman","megaman","sonic","mewtwo","lucas","roy","ryu","cloud","corrin","bayonetta","miibrawler1","miigunner1","miisword1","miibrawler","miigunner","miisword"];
		var singleTier = "<tr><td class='labelHolder' contenteditable='true' style='background-color:#FFFF7F'><span class='label'>NEW</span></td><td><div class='tier sort' id='rows'><div class='hiddenkid'></div></div></td><td><div id='settings'></div><div id='moveButtons'><div id='moveUp'></div><div id='moveDown'></div></div></td></tr>";
		
		var screenshotMode = false;
		var colors = ["#FF7F7F","#FFBF7F","#FFDF7F","#FFFF7F","#BFFF7F","#7FFF7F","#7FFFFF","#7FBFFF","#7F7FFF","#FF7FFF","#BF7FBF","#3B3B3A","#858585","#CFCFCF","#F7F7F7"];
		// first is the row in the table of the tier, second is the index of its color
		var tierDefaults = [ [$("tr:nth-of-type(1)"), 0],
					  [$("tr:nth-of-type(2)"), 1],
					  [$("tr:nth-of-type(3)"), 3],
					  [$("tr:nth-of-type(4)"), 5],
					  [$("tr:nth-of-type(5)"), 7],
					  [$("tr:nth-of-type(6)"), 8],
					  [$("tr:nth-of-type(7)"), 9] ];
		var tier = []; // format: [element, color id]
		var tierlist = [];
		var currentTier; // i mean come on!
		var tempTier;
		var tierIndex;
		var currentColor;
		var colorIndex;
		var currentGame;
		var currentGameChars = gameSmash4;
		var characters;
		var resized,tableWidth;
					  
		for (var i = 0; i < tierDefaults.length; i++) {
			tierDefaults[i][0].find(".labelHolder").css("background",colors[tierDefaults[i][1]]);
		}
			
		$(document).on("click", "#settings", function() { // open settings modal
			currentTier = $(this).parent().parent();
			currentColor = currentTier.find(".labelHolder").css("background-color");
			$("textarea").val(currentTier.find(".labelHolder").text());
			colorIndex = colors.indexOf(rgb2hex(currentColor).toUpperCase());
			tier = [currentTier, colorIndex];
			console.log(tier);
			for (var i = 0; i < $("#modal span").length; i++) {
				$("#modal span:nth-of-type("+(i+1)+")").attr("class","nope");
			}
			$("#modal span:nth-of-type("+(colorIndex+1)+")").attr("class","selected");
			$("#modal").css("display","block");
			$("#overlay").css("opacity", 1);
			$("#overlay").css("visibility", "visible");
			$("#modal").css("top",alignPopup($("#modal")));
		});
		
		$(document).on("click", "#game", function() { // open game changer modal
			$("#gameChange").css("display","block");
			$("#overlay").css("opacity", 1);
			$("#overlay").css("visibility", "visible");
			$("#gameChange").css("top",alignPopup($("#gameChange")));
		});
		
		$(document).on("click", "#help", function() { // open help modal
			$("#helpMenu").css("display","block");
			$("#overlay").css("opacity", 1);
			$("#overlay").css("visibility", "visible");
			$("#helpMenu").css("top",alignPopup($("#helpMenu")));
		});
		
		$(document).on("click", "#colorselect span", function() { // change row label
			for (var i = 0; i < $("#modal span").length; i++) {
				$("#modal span:nth-of-type("+(i+1)+")").attr("class","nope");
			}
			$(this).attr("class","selected");
			currentTier.find(".labelHolder").css("background-color",$(this).css("background-color"));
			updateTiers();
		});
		
		$(document).on("click", "#gameChange button", function() { // change game
			console.log("game switching");
			switch($(this).attr("id")) {
				case "switchSmash4": changeGame(gameSmash4);break;
				case "switchSSB4Renders": changeGame(gameSSB4Renders);break;
				case "switchhelp": changeGame(gamehelp);break;
				case "switchUltimate": changeGame(gameUltimate);break;
				}
		});
			
		$(document).on("click", function(e) {
			clicked = e.target.id;
			if(clicked == "overlay" || clicked == "modalWrapper" || clicked == "close") { // close modals
				$("#overlay").css("opacity", 0);
				$("#overlay").css("visibility", "hidden");
				$("#modal").css("display", "none");
				$("#gameChange").css("display", "none");
				$("#helpMenu").css("display", "none");
				$("#screenshotShow").css("display", "none");
			} else if(clicked == "screenshot") { // take a screenshot
				$("#exportcode").val(toCode());
				$("#modal").css("display", "none");
				$("#gameChange").css("display", "none");
				$("#helpMenu").css("display", "none");
				$("#screenshotShow canvas").remove();
				$("#screenshotShow").css("display","block");
				$("#overlay").css("opacity", 1);
				$("#overlay").css("visibility", "visible");
				$("td:last-of-type").css("display","none");
				html2canvas($("table"), {
				  onrendered: function(canvas) {
					$("#screenshotShow span").after(canvas);
					$("td:last-of-type").css("display","table-cell");
					$("#screenshotShow").css("top",alignPopup($("#screenshotShow")));
				  }
				});
				

			} else if (clicked == "Bleg") {
        Bleg();
	    
			} else if(clicked == "hidebuttons") { // hide the buttons
				if (screenshotMode) {
					$("td:last-of-type").css("display","table-cell");
					$("#hidebuttons").text("Hide controls");
					screenshotMode = false;
				} else {
					$("td:last-of-type").css("display","none");
					$("#hidebuttons").text("Show controls");
					screenshotMode = true;
				}
			} else if(clicked == "clearRow") { // put characters in this row back into the box
				for(var i = 0; i < currentTier.find("#rows div").length; i++) {
					$("#char div:last-child").after(currentTier.find("#rows div"));
				}
			} else if(clicked == "deleteRow") { // delete this row
				for(var i = 0; i < currentTier.find("#rows div").length; i++) {
					$("#char div:last-child").after(currentTier.find("#rows div"));
				}
				currentTier.remove();
				updateTiers();
				$("#overlay").css("opacity", 0);
				$("#overlay").css("visibility", "hidden");
				$("#modal").css("display", "none");
			} else if (clicked == "addRowUp") { // add a row on top of the current row
				$("tr:nth-of-type("+($("tr").index(currentTier)+1)+")").before(singleTier);
				updateTiers();
			} else if (clicked == "addRowBelow") { // add a row below the current row
				$("tr:nth-of-type("+($("tr").index(currentTier)+1)+")").after(singleTier);
				updateTiers();
			} else if (clicked == "moveUp") { // move the row above the row above it
				currentTier = $(e.target).closest("tr");
				if (currentTier.prev("tr").length != 0)
					currentTier.insertBefore(currentTier.prev("tr"));
			} else if (clicked == "moveDown") { // move the row below the row below it
				currentTier = $(e.target).closest("tr");
				if (currentTier.next("tr").length != 0)
					currentTier.insertAfter(currentTier.next("tr"));
			} else if (clicked == "runCode") {
				loadCode($("#exportcode").val());
			} else if (clicked == "reset") {
				switch(currentGameChars[0]) {
					case "trash": changeGame(gameSmash4);break;
					case "help": changeGame(gamehelp);break;
					case "ultimate": changeGame(gameUltimate);break;

				}
				loadCode(currentGameChars[0]+"==S|0==A|1==B|3==C|5==D|7==E|8==F|9");
			}
		});
		
		$("#labelName").bind("input propertychange", function() {
			currentTier.find(".label").html($("#labelName").val().replace(/\n/g, "<br>"));
		});
		
		// http://stackoverflow.com/a/3971432 thanks Zack Katz :D
		function rgb2hex(rgb) {
			rgb = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);
			function hex(x) {
				return ("0" + parseInt(x).toString(16)).slice(-2);
			}
			return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
		}
		
		function updateTiers() {
			tierlist = [];
			tempTier = currentTier;
			for (var i = 0; i < $("tr").length; i++) {
				currentTier = $("tr:nth-of-type("+(i+1)+")");
				currentColor = currentTier.find(".labelHolder").css("background-color"); // returns in rgb format, have to convert to hex
				tier[0] = currentTier;
				tier[1] = colors.indexOf(rgb2hex(currentColor).toUpperCase());
				console.log(tier);
				tierlist.push(tier);
			}
			currentTier = tempTier;
			console.log(tierlist);
		}
		
		function changeGame(game) {
			currentGameChars = [];
			currentGameChars = game;
			currentGame = game[0];
			$(".character").each( function() {
				$(this).remove();
			});
			for (var i = 1; i < game.length; i++) {
				$("#char div:last-child").after(singleChar);
				$("#char div:last-child").css("background-image","url(img/"+currentGame+"/"+game[i]+".png)");
				$("#char div:last-child").attr("id",i);
			}
			$("h1 span").text(currentGame);
			updateTiers();
		}
		
		function toCode() { // format game==label|color|char1|char2|...==label|color|char1|char2|...==...
			var codeColors = [], labels = [], currentChars = [], shareCode = "";
			characters = [];
			$("tr").each( function() {
				currentChars = [];
				labels.push($(this).find(".label").html());
				codeColors.push(colors.indexOf(rgb2hex($(this).find(".labelHolder").css("background-color")).toUpperCase()));
				$(this).find(".character").each( function() {
					currentChars.push($(this).attr("id"));
				});
				characters.push(currentChars);
			});
			shareCode += currentGame + "==";
			for (var i = 0; i < labels.length; i++) {
				shareCode += labels[i] +"|"+ codeColors[i];
				if (characters[i].length != 0)
					shareCode += "|";
				for (var c = 0; c < characters[i].length; c++) {
					shareCode += characters[i][c];
					if (c != characters[i].length-1)
						shareCode += "|";
				}
				if (i != labels.length-1)
					shareCode += "==";
			}
			console.log(shareCode);
			return shareCode;
		}
		
function Bleg() {
    var code, maxNumTiers, minNumTiers, numTiers, tiers, characters, numCharacters, numCharactersLeft, i, j, x, y;
    // Initialize our variables
    code = "trash";
    maxNumTiers = 8;
    minNumTiers = 6;
    numCharacters = 62;
    numCharactersLeft = numCharacters;
    numTiers = Math.floor(Math.random() * Math.floor(maxNumTiers - minNumTiers + 1) ) + minNumTiers;
    tiers = ["==S|0", "==A|1", "==B|3", "==C|4", "==D|6", "==E|8", "==F|9", "==G|11"];
    characters = [];

    // Establish the characters
    for (i = 0; i < numCharacters; i++) {
        characters[i] = i + 1;
    }
    // Randomly generate the string
    for (i = 0; i < numCharacters; i++) {
        //x is the random tier being added to, y is the random character chosen
        x = Math.floor(Math.random() * Math.floor(numTiers));
        y = Math.floor(Math.random() * Math.floor(numCharactersLeft));
        tiers[x] += "|" + characters[y].toString();
        for (j = y; j < numCharactersLeft - 1; j++) {
            characters[j] = characters[j + 1];
        }
        numCharactersLeft--;
    }
    // Assemble the code
    for (i = 0; i < numTiers; i++) {
        code += tiers[i];
    }
    loadCode(code);
}
		
		function loadCode(code) {
			var codeSplit = [], tempTier = [], processedCode = [];
			codeSplit = code.split("==");
			for (var i = 0; i < codeSplit.length; i++) {
				tempTier = codeSplit[i].split("|");
				for (var c = 1; c < tempTier.length; c++)
					tempTier[c] = Number(tempTier[c]);
				processedCode[i] = tempTier;
			}
			$("tr").each( function() {
				$(this).remove();
			});
			console.log(processedCode);
			switch(processedCode[0][0]) {
				case "trash": changeGame(gameSmash4);break;
				case "help": changeGame(gamehelp);break;
				case "ultimate": changeGame(gameUltimate);break;
}
			for (var i = 1; i < processedCode.length; i++) {
				$("tbody").append(singleTier);
				$("tr:last-of-type").find(".labelHolder").css("background-color",colors[processedCode[i][1]]);
				$("tr:last-of-type").find(".label").html(processedCode[i][0]);
				for (var c = 2; c < processedCode[i].length; c++) {
					$("tr:last-of-type").find(".tier div:last-child").after(singleChar);
					$("tr:last-of-type").find(".tier div:last-child").css("background-image","url(img/"+processedCode[0]+"/"+currentGameChars[processedCode[i][c]]+".png)");
					$("tr:last-of-type").find(".tier div:last-child").attr("id",processedCode[i][c]);
					$("#char #"+processedCode[i][c]).remove();
				}
			}
		}
		
		function tierlistSize() {
			if ($("table").width > $("#tablewrap").width)
				$("#tablewrap").css("display","table-cell");
			else
				$("#tablewrap").css("display","block");
		}
		
		function alignPopup(popup) {
			return Math.floor(($(window).height() - popup.height())/2)+"px";
		}
		
		$(document).ready( function() {
			$("#char").html("<div></div>");
			if (localStorage.getItem("TierListMakerCode") === null)
				changeGame(gameSmash4);
			else {
				$("#exportcode").val(localStorage.getItem("TierListMakerCode"));
				loadCode(localStorage.getItem("TierListMakerCode"));
			}
			updateTiers();
			tierlistSize();
		});
		$(window).resize( function () {
			tierlistSize();
		})
		
	</script>
</body>
</html>
